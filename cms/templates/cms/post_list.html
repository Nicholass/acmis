{% extends 'cms/base.html' %}
{% load i18n %}
{% load comments %}
{% load auth %}

{% block title %}
  {% if author %}
    {% trans "ACIS - Материалы пользователя " %}{{ author }}
  {% elif category %}
    {% trans "ACIS - " %}{{ category }}
  {% elif tags %}
    {% trans "ACIS - Материалы" %}
  {% endif %}

  {% if tags %}
    {% trans " по тэгам " %}{% for tag in tags %}{% if not forloop.first %}&nbsp;{% endif %}#{{ tag }}{% endfor %}
  {% endif %}
{% endblock %}


{% block breadcrumbs %}
  {% if author %}
    {% if tags %}
      <li><a href="{% url 'author_list' author=author %}">
    {% else %}
      <li class="current">
    {% endif %}

    {{ author }}
  {% elif category %}
    {% if tags %}
      <li><a href="{% url 'category_list' category=category.route %}">
    {% else %}
      <li class="current">
    {% endif %}

    {{ category }}
  {% endif %}

  {% if tags %}
    </a></li>
    <li class="sep">&#187;</li>
    <li class="current">{% for tag in tags %}{% if not forloop.first %}&nbsp;{% endif %}#{{ tag }}{% endfor %}</li>
  {% else %}
    </li>
  {% endif %}
{% endblock %}

{% block content %}
  <div class="block">
    <h1 class="header-simple">
      {% if author %}
        {% trans "Материалы автора " %}{{ author }}
      {% elif category %}

        {# TODO: перевод названия категории на уровне модели #}
          {{ category }}
      {% elif tags %}
        {% trans "Материалы" %}
      {% endif %}

      {% if tags %}
        {% trans " по тегам " %}{% for tag in tags %}{% if not forloop.first %}&nbsp;{% endif %}#{{ tag }}{% endfor %}
      {% endif %}
    </h1>

    {% if category and user.is_authenticated and perms.cms.add_post %}
      <div class="category-menu">
        <a href="{% url 'post_new' category=category.route %}">
          {% trans "Добавить " %}

          {# TODO: перевод названия категории на уровне модели #}

          {% if category.route == 'drawing' %}
            {% trans "рисунок" %}
          {% elif category.route == 'map' %}
            {% trans "карту" %}
          {% elif category.route == 'news' %}
            {% trans "новость" %}
          {% elif category.route == 'photo' %}
            {% trans "фотографию" %}
          {% elif category.route == 'prose' %}
            {% trans "рассказ" %}
          {% elif category.route == 'report' %}
            {% trans "отчет" %}
          {% endif %}
        </a>
      </div>
    {% endif %}

    <div class="content">
      {% if not posts %}
        <p>
          {% url 'post_new' category=category.route as post_new_url %}
          {% blocktrans with post_new_url=post_new_url %}
          В категории пока нет материалов. Вы можете <a href="{{ post_new_url }}">добавить</a> первым.
          {% endblocktrans %}
        </p>
      {% endif %}

      {% for post in posts %}
        <div class="post" id="{{ post.pk }}">
          <h2>
            {% if category.route == 'map' %}
              <a href="{% url 'map_file' map_hash=post.hash %}">{{ post.title }}</a>
            {% else %}
              <a href="{% url 'post_detail' pk=post.pk %}">{{ post.title }}</a>
            {% endif %}
          </h2>
          <p class="info">
            {{ post.created_date }}
            <span class="sep">|</span>
            <a href="{% url 'author_list' author=post.author %}">{{ post.author }}</a>

            {% comment_count as comm_count %}
            {% if comm_count %}
              <span class="sep">|</span>
              <a href="{% url 'post_detail' pk=post.pk %}#comments">{{ comm_count }}
                {% if comm_count|plural_type == 1 %}{% trans "комментарий" %}{% endif %}
                {% if comm_count|plural_type == 2  %}{% trans "комментария" %}{% endif %}
                {% if comm_count|plural_type == 3  %}{% trans "комментариев" %}{% endif %}
              </a>
            {% endif %}
          </p>

            <p class="content">
            {% if not post.file %}
              {{ post.text|linebreaksbr|truncatechars:400 }}
            {% else %}
              <a href="{% url 'post_detail' pk=post.pk %}"><img class="image" src="{{ MEDIA_URL }}{{ post.file }}" alt="{{ post.title }}" /></a>
            {% endif %}
            </p>

           <p class="tags">
          {% if post.tags.all %}
              <i class="fa fa-tags"></i>
              {% for tag in post.tags.all %}
                {% if not forloop.first %}&nbsp;{% endif %}
                {% if author %}
                  <a href="{% url 'author_tags_list' author=author tags=tag.name %}">#{{ tag.name }}</a>
                {% else %}
                  <a href="{% url 'category_tags_list' category=post.category.route tags=tag.name %}">#{{ tag.name }}</a>
                {% endif %}
                {% if not forloop.last %}, {% endif %}
              {% endfor %}
          {% endif %}
          </p>

          <p class="actions">
            {% auth_is_owner post as is_post_owner %}
            {% if user.is_authenticated %}
              {% auth_is_owner post as is_post_owner %}

              {% if perms.cms.change_post and is_post_owner %}
                <a href="{% url 'post_edit' pk=post.pk %}">{% trans "Редактировать" %}</a>
                <span class="sep">|</span>
              {% endif %}

              {% if perms.cms.delete_post and is_post_owner %}
                <a href="{% url 'post_delete' pk=post.pk %}" onclick="return confirm('{% trans "Вы уверены, что хотите удалить пост? Отменить это действие будет невозможно." %}')">{% trans "Удалить" %}</a>
                <span class="sep">|</span>
              {% endif %}

              {% if post.is_public %}
                <a href="#">{% trans "Скрыть" %}</a>
              {% else %}
                <a href="#">{% trans "Опубликовать" %}</a>
              {% endif %}
            {% endif %}
          </p>
        </div>
      {% endfor %}

    </div>

    {% if posts.has_other_pages %}
      <ul class="pagination">
        {% if posts.has_previous %}
          <li><a href="?page={{ posts.previous_page_number }}">&laquo;</a></li>
        {% else %}
          <li class="disabled"><span>&laquo;</span></li>
        {% endif %}
        {% for i in posts.paginator.page_range %}
          {% if posts.number == i %}
            <li class="active"><span>{{ i }}</span></li>
          {% else %}
            <li><a href="?page={{ i }}">{{ i }}</a></li>
          {% endif %}
        {% endfor %}
        {% if posts.has_next %}
          <li><a href="?page={{ posts.next_page_number }}">&raquo;</a></li>
        {% else %}
          <li class="disabled"><span>&raquo;</span></li>
        {% endif %}
      </ul>
    {% endif %}

  </div>
{% endblock %}
