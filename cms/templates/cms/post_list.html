{% extends 'cms/base.html' %}
{% load i18n %}
{% load comments %}
{% load auth %}
{% load bleach_tags %}

{% block title %}
  {% if author %}
    {% trans "ACIS - Материалы пользователя " %}{{ author }}
  {% elif category %}
    {% trans "ACIS - " %}{{ category }}
  {% elif tags %}
    {% trans "ACIS - Материалы" %}
  {% endif %}

  {% if tags %}
    {% trans " по тэгам " %}{% for tag in tags %}{% if not forloop.first %}&nbsp;{% endif %}#{{ tag }}{% endfor %}
  {% endif %}
{% endblock %}


{% block breadcrumbs %}
  {% if author %}
    {% if tags %}
      <li><a href="{% url 'author_list' author=author %}">
    {% else %}
      <li class="current">
    {% endif %}

    {{ author }}
  {% elif category %}
    {% if tags or is_disapproved %}
      <li><a href="{% url 'category_list' category=category.route %}">
    {% else %}
      <li class="current">
    {% endif %}

    {{ category }}
  {% endif %}

  {% if tags or is_disapproved  %}
    </a></li>
    <li class="sep">&#187;</li>
    <li class="current">{% for tag in tags %}{% if not forloop.first %}&nbsp;{% endif %}#{{ tag }}{% endfor %}</li>
  {% else %}
    </li>
  {% endif %}

  {% if is_disapproved %}
      <li class="current">{% trans "премодерация" %}</li>
  {% endif %}
{% endblock %}

{% block content %}
  <div class="block">
    <h1 class="header-simple">
      {% if author %}
        {% trans "Материалы автора " %}{{ author }}
      {% elif category %}
          {% if is_disapproved %}
            {% trans "премодерация постов категории " %}
          {% endif %}

          {# TODO: перевод названия категории на уровне модели #}
          {{ category }}
      {% elif tags %}
        {% trans "Материалы" %}
      {% endif %}

      {% if tags %}
        {% trans " по тегам " %}{% for tag in tags %}{% if not forloop.first %}&nbsp;{% endif %}#{{ tag }}{% endfor %}
      {% endif %}
    </h1>

      {% if category and user.is_authenticated %}
        <div class="category-menu">
          {% if perms.cms.add_post %}
              <a href="{% url 'post_new' category=category.route %}">
                {% trans "Добавить " %}

                {# TODO: перевод названия категории на уровне модели #}

                {% if category.route == 'drawing' %}
                  {% trans "рисунок" %}
                {% elif category.route == 'map' %}
                  {% trans "карту" %}
                {% elif category.route == 'news' %}
                  {% trans "новость" %}
                {% elif category.route == 'photo' %}
                  {% trans "фотографию" %}
                {% elif category.route == 'prose' %}
                  {% trans "рассказ" %}
                {% elif category.route == 'report' %}
                  {% trans "отчет" %}
                {% endif %}
              </a>
          {% endif %}

          {% if perms.cms.moderate_post and posts_disapproved > 0 %}
              <strong><a href="{% url 'category_disapproved' category=category.route %}" class="link_dissaproved">Ожидают модерации ({{ posts_disapproved }})</a></strong>
          {% endif %}
        </div>
      {% endif %}

    <div class="content {{ category.route }}">
      {% if not posts %}
        <p>
          {% if not is_disapproved %}
            {% url 'post_new' category=category.route as post_new_url %}
            {% blocktrans with post_new_url=post_new_url %}
            В категории пока нет материалов. Вы можете <a href="{{ post_new_url }}">добавить</a> первым.
            {% endblocktrans %}
          {% else %}
              {% trans "В категории нет постов ожидающих премодерации." %}
          {% endif %}
        </p>
      {% endif %}

      {% for post in posts %}
        {% auth_is_owner post as is_post_owner %}

        {% if post.is_public or is_post_owner or perms.cms.moderate_post %}
        <div class="post{% if not post.is_public %} hidden{% endif %}{% if not post.is_moderated %} disaproved{% endif %}" id="{{ post.pk }}">
          <h2>
            {% if post.category.route == 'map' %}
              <a href="{% url 'map_file' map_hash=post.hash %}">{{ post.title }}</a>
            {% else %}
              <a href="{% url 'post_detail' pk=post.pk %}">{{ post.title }}</a>
            {% endif %}
          </h2>
          <div class="info">
            {% if category.route == 'photo' or category.route == 'drawing' %}
                <p><a class="fa-link" href="{% url 'category_list' category=post.category.route %}">
                    <i class="fa fa-list-ul"></i>
                    {# TODO: перевод названия категории на уровне модели #}

                    {% if post.category.route == 'drawing' %}
                      {% trans "Графика" %}
                    {% elif post.category.route == 'map' %}
                      {% trans "Карты" %}
                    {% elif post.category.route == 'news' %}
                      {% trans "Новости" %}
                    {% elif post.category.route == 'photo' %}
                      {% trans "Фотографии" %}
                    {% elif post.category.route == 'prose' %}
                      {% trans "Писательство" %}
                    {% elif post.category.route == 'report' %}
                      {% trans "Отчеты" %}
                    {% endif %}
                </a></p>
                <p><span class="fa-link"><i class="fa fa-calendar"></i>{{ post.created_date }}</span></p>
                <p><a href="{% url 'author_list' author=post.author %}" class="fa-link"><i class="fa fa-user-o"></i>{{ post.author }}</a></p>
            {% else %}
                <a class="fa-link" href="{% url 'category_list' category=post.category.route %}">
                    <i class="fa fa-list-ul"></i>
                    {# TODO: перевод названия категории на уровне модели #}

                    {% if post.category.route == 'drawing' %}
                      {% trans "Графика" %}
                    {% elif post.category.route == 'map' %}
                      {% trans "Карты" %}
                    {% elif post.category.route == 'news' %}
                      {% trans "Новости" %}
                    {% elif post.category.route == 'photo' %}
                      {% trans "Фотографии" %}
                    {% elif post.category.route == 'prose' %}
                      {% trans "Писательство" %}
                    {% elif post.category.route == 'report' %}
                      {% trans "Отчеты" %}
                    {% endif %}
                </a>
                <span class="fa-link"><i class="fa fa-calendar"></i>{{ post.created_date }}</span>
                <a href="{% url 'author_list' author=post.author %}" class="fa-link"><i class="fa fa-user-o"></i>{{ post.author }}</a>
            {% endif %}

            {% comment_count as comm_count %}
            {% if comm_count and category.route != 'map' %}

              {% if category.route == 'photo' or category.route == 'drawing' %}
                <p>
              {% endif %}

              <a href="{% url 'post_detail' pk=post.pk %}#comments" class="comments-link fa-link"><i class="fa fa-comment-o"></i>{{ comm_count }}
                {% if comm_count|plural_type == 1 %}{% trans "комментарий" %}{% endif %}
                {% if comm_count|plural_type == 2  %}{% trans "комментария" %}{% endif %}
                {% if comm_count|plural_type == 3  %}{% trans "комментариев" %}{% endif %}
              </a>

              {% if category.route == 'photo' or category.route == 'drawing' %}
                </p>
              {% endif %}

            {% endif %}
          </div>

          {% if post.category.route != 'map' %}
            <div class="content clearfix">
            {% if not post.file %}
              {{ post.text|truncatechars:800|bleach }}
            {% else %}
              <a href="{% url 'post_detail' pk=post.pk %}"><img class="image" src="{{ MEDIA_URL }}{{ post.file }}" alt="{{ post.title }}" /></a>
            {% endif %}
            </div>
          {% endif %}

          {% if post.tags.all %}
            <div class="tags">
              <i class="fa fa-tags"></i>
              {% for tag in post.tags.all %}
                {% if not forloop.first %}&nbsp;{% endif %}
                {% if author %}
                  <a href="{% url 'author_tags_list' author=author tags=tag.name %}">#{{ tag.name }}</a>
                {% else %}
                  <a href="{% url 'category_tags_list' category=post.category.route tags=tag.name %}">#{{ tag.name }}</a>
                {% endif %}
                {% if not forloop.last %}, {% endif %}
              {% endfor %}
            </div>
          {% endif %}

          <div class="actions">
            {% if user.is_authenticated %}
              {% auth_is_owner post as is_post_owner %}

              {% if perms.cms.change_post and is_post_owner %}
                  <a href="{% url 'post_edit' pk=post.pk %}" class="fa-link" title="{% trans "Редактировать" %}"><i class="fa fa-pencil"></i></a>
              {% endif %}

              {% if perms.cms.delete_post and is_post_owner %}
                <a href="{% url 'post_delete' pk=post.pk %}" onclick="return confirm('{% trans "Вы уверены, что хотите удалить пост? Отменить это действие будет невозможно." %}')" class="fa-link" title="{% trans "Удалить" %}"><i class="fa fa-trash-o"></i></a>
              {% endif %}

              {% if perms.cms.publish_post and is_post_owner %}
                {% if post.is_public %}
                  <a href="{% url 'post_unpublish' pk=post.pk %}" class="fa-link" title="{% trans "Скрыть" %}"><i class="fa fa-eye-slash"></i></a>
                {% else %}
                  <a href="{% url 'post_publish' pk=post.pk %}" class="fa-link"><i class="fa fa-eye" title="{% trans "Опубликовать" %}"></i></a>
                {% endif %}
              {% endif %}
              {% if perms.cms.moderate_post %}
                {% if not post.is_moderated %}
                  <a href="{% url 'post_approve' pk=post.pk %}" class="fa-link" title="{% trans "Одобрить" %}"><i class="fa fa-check-square-o"></i></a>
                {% endif %}
              {% endif %}
            {% endif %}
          </div>
        </div>
        {% endif %}
      {% endfor %}

    </div>

    {% if posts.has_other_pages %}
      <ul class="pagination">
        {% if posts.has_previous %}
          <li><a href="?page={{ posts.previous_page_number }}">&laquo;</a></li>
        {% else %}
          <li class="disabled"><span>&laquo;</span></li>
        {% endif %}
        {% for i in posts.paginator.page_range %}
          {% if posts.number == i %}
            <li class="active"><span>{{ i }}</span></li>
          {% else %}
            <li><a href="?page={{ i }}">{{ i }}</a></li>
          {% endif %}
        {% endfor %}
        {% if posts.has_next %}
          <li><a href="?page={{ posts.next_page_number }}">&raquo;</a></li>
        {% else %}
          <li class="disabled"><span>&raquo;</span></li>
        {% endif %}
      </ul>
    {% endif %}

  </div>
{% endblock %}
