{% extends 'cms/base.html' %}
{% load i18n %}
{% load comments %}
{% load auth %}
{% load bleach_tags %}
{% load thumbnail %}
{% load staticfiles %}
{% load opengraph %}
{% load announce %}
{% load hitcount_tags %}
{% load bleach_src_filter %}

{% block title %}{{ page_title }}{% endblock %}

{% block og %}
    {% opengraph title=page_title %}
{% endblock %}

{% block breadcrumbs %}
  {% if author %}
    {% if tags %}
        <li><a href="{% url 'author_list' author=author %}">{{ author }}</a></li>
    {% else %}
        <li class="current">{{ author }}</li>
    {% endif %}

  {% elif category %}
    {% if tags or is_disapproved %}
        <li><a href="{% url 'category_list' category=category.route %}">{{ category }}</a></li>
    {% else %}
        <li class="current">{{ category }}</li>
    {% endif %}
  {% endif %}

  {% if tags %}
      <li class="current">{% for tag in tags %}{% if not forloop.first %}&nbsp;{% endif %}#{{ tag }}{% endfor %}</li>
  {% elif is_disapproved %}
      <li class="current">{% trans "Премодерация" %}</li>
  {% endif %}
{% endblock %}

{% block content %}
        {% if category and user.is_authenticated %}
          <div class="actions">
            {% if perms.cms.add_cmspost %}
                <a href="{% url 'post_new' category=category.route %}">
                  <i class="fa fa-file"></i>
                  {% trans "Добавить " %}

                  {# TODO: перевод названия категории на уровне модели #}

                  {% if category.route == 'drawing' %}
                    {% trans "рисунок" %}
                  {% elif category.route == 'map' %}
                    {% trans "карту" %}
                  {% elif category.route == 'news' %}
                    {% trans "новость" %}
                  {% elif category.route == 'photo' %}
                    {% trans "фотографию" %}
                  {% elif category.route == 'prose' %}
                    {% trans "рассказ" %}
                  {% elif category.route == 'report' or category.route == 'pm_report'  %}
                    {% trans "отчет" %}
                  {% endif %}
                </a>
            {% endif %}

            {% if perms.cms.moderate_cmspost and posts_disapproved > 0 %}
                <a href="{% url 'category_disapproved' category=category.route %}">
                  <i class="fa fa-check-square"></i>
                  Ожидают модерации ({{ posts_disapproved }})
                </a>
            {% endif %}
          </div>
        {% endif %}

        <h1>{{ page_title }}</h1>

        <a class="feed" href="{% url 'feed_latest' %}" title="RSS"><img src="{% static 'images/rss.png' %}" alt="rss"></a>

        <div class="posts{% if category.route == 'photo' or category.route == 'drawing' %} tiles{% elif category.route == 'map' %} list{% endif %}">
      {% if not posts %}
        <p class="nocontent">
          {% if not is_disapproved %}
              {% if is_home %}
                  {% trans "На сайте пока нет материалов. Для добавления нового материала перейдите в категорию." %}
              {% else %}
                  {% trans "В категории пока нет материалов." %}
                  {% if perms.cms.add_cmspost %}
                    {% url 'post_new' category=category.route as post_new_url %}
                    {% blocktrans with post_new_url=post_new_url %}
                    В категории пока нет материалов. Вы можете <a href="{{ post_new_url }}">добавить</a> первым.
                    {% endblocktrans %}
                  {% endif %}
              {% endif %}
          {% else %}
              {% trans "В категории нет постов ожидающих премодерации." %}
          {% endif %}
        </p>
      {% endif %}

      {% for post in posts %}
        {% auth_is_owner post as is_post_owner %}

        {% if post.is_public or is_post_owner or perms.cms.moderate_cmspost %}
        <div class="post{% if not post.is_public %} hidden{% endif %}{% if not post.is_moderated %} disaproved{% endif %}" id="{{ post.pk }}">
          <h2>
            {% if post.category.route == 'map' %}
                {% if not need_relogin %}
                    <a href="{% url 'map_file' map_hash=post.hash %}">{{ post.title }}</a>
                {% else %}
                    {{ post.title }}
                {% endif %}
            {% else %}
              <a href="{% url 'post_detail' pk=post.pk %}">{{ post.title }}</a>
            {% endif %}
          </h2>
          <div class="info">
            {% if not category %}
            <span>
                <i class="fa fa-list"></i>
                <a href="{% url 'category_list' category=post.category.route %}">
                    {# TODO: перевод названия категории на уровне модели #}

                    {% if post.category.route == 'drawing' %}
                      {% trans "Графика" %}
                    {% elif post.category.route == 'map' %}
                      {% trans "Карты" %}
                    {% elif post.category.route == 'news' %}
                      {% trans "Новости" %}
                    {% elif post.category.route == 'photo' %}
                      {% trans "Фотографии" %}
                    {% elif post.category.route == 'prose' %}
                      {% trans "Писательство" %}
                    {% elif post.category.route == 'report' %}
                      {% trans "Отчеты" %}
                    {% endif %}
                </a>
            </span>
            {% endif %}
            <span>
                <i class="fa fa-calendar"></i>
                {{ post.created_date }}
            </span>
            {% if category.route == 'photo' or category.route == 'drawing' %}<br>{% endif %}
            <span>
                <i class="fa fa-user"></i>
                <a href="{% url 'author_list' author=post.author %}">{{ post.author }}</a>
            </span>

            <span>
                <i class="fa fa-eye"></i>
                {% get_hit_count for post %}
            </span>

            <span>
                <i class="fa fa-comment"></i>
                <a href="{% url 'post_detail' pk=post.pk %}#comments" class="comments-link">
            {% comment_count as comm_count %}
            {% if comm_count and category.route != 'map' %}
                {{ comm_count }}
                {% if comm_count|plural_type == 1 %}{% trans "комментарий" %}{% endif %}
                {% if comm_count|plural_type == 2  %}{% trans "комментария" %}{% endif %}
                {% if comm_count|plural_type == 3  %}{% trans "комментариев" %}{% endif %}
            {% else %}
                {% trans "Комментировать" %}
            {% endif %}
              </a>
            </span>
          </div>

          <div class="post-content clearfix">
            {% if post.category.route != 'map' %}
              {% if not post.file %}
                  {{ post.text|truncatechars:800|hide_announced_item|bleach_src|bleach }}
                  {% get_announce post as announce %}
                  <p>{{ announce|bleach_src|bleach }}</p>
              {% else %}
                  <a href="{% url 'post_detail' pk=post.pk %}">
                    {% if category and category.route == 'photo' or category.route == 'drawing' %}
                      {% thumbnail post.file "x100" as th_im %}
                          <img class="image" src="{{ th_im.url }}" alt="{{ post.title }}" />
                      {% endthumbnail %}
                    {% else %}
                      {% thumbnail post.file "900" as th_im %}
                          <img class="image" src="{{ th_im.url }}" alt="{{ post.title }}" />
                      {% endthumbnail %}
                    {% endif %}
                  </a>
              {% endif %}
            {% else %}
              {% if need_relogin %}
                <p>{% trans "Для открытия доступа к картам пожалуста выйдите и зайдите на сайт снова" %}</p>
              {% endif %}
            {% endif %}
          </div>


          {% if post.tags.all %}
            <div class="tags">
              <i class="fa fa-tags"></i>
              {% for tag in post.tags.all %}
                {% if not forloop.first %}&nbsp;{% endif %}
                {% if author %}
                  <a href="{% url 'author_tags_list' author=author tags=tag.name %}">#{{ tag.name }}</a>
                {% elif category %}
                  <a href="{% url 'category_tags_list' category=post.category.route tags=tag.name %}">#{{ tag.name }}</a>
                {% else %}
                  <a href="{% url 'tag_list' tags=tag.name %}">#{{ tag.name }}</a>
                {% endif %}
                {% if not forloop.last %}, {% endif %}
              {% endfor %}
            </div>
          {% endif %}

          <div class="actions">
            {% if user.is_authenticated %}
              {% auth_is_owner post as is_post_owner %}

              {% if perms.cms.change_cmspost and is_post_owner %}
                  <a href="{% url 'post_edit' pk=post.pk %}"><i class="fa fa-edit"></i> {% trans " Редактировать" %}</a>
              {% endif %}
              {% if category.route == 'photo' or category.route == 'drawing' %}<br>{% endif %}
              {% if perms.cms.delete_cmspost and is_post_owner %}
                <a href="{% url 'post_delete' pk=post.pk %}" onclick="return confirm('{% trans "Вы уверены, что хотите удалить пост? Отменить это действие будет невозможно." %}')"><i class="fa fa-trash"></i>{% trans " Удалить" %}</a>
              {% endif %}
              {% if category.route == 'photo' or category.route == 'drawing' %}<br>{% endif %}
              {% if perms.cms.publish_cmspost and is_post_owner %}
                {% if post.is_public %}
                  <a href="{% url 'post_unpublish' pk=post.pk %}"><i class="fa fa-eye-slash"></i>{% trans " Скрыть" %}</a>
                {% else %}
                  <a href="{% url 'post_publish' pk=post.pk %}"><i class="fa fa-eye"></i>{% trans " Опубликовать" %}</a>
                {% endif %}
              {% endif %}
              {% if perms.cms.moderate_cmspost %}
                {% if not post.is_moderated %}
                  {% if category.route == 'photo' or category.route == 'drawing' %}<br>{% endif %}
                  <a href="{% url 'post_approve' pk=post.pk %}"><i class="fa fa-check"></i>{% trans " Одобрить" %}</a>
                {% endif %}
              {% endif %}
            {% endif %}
          </div>
        </div>
        {% endif %}
      {% endfor %}

    </div>

    {% if posts.has_other_pages %}
      <ul class="pagination">
        {% if posts.has_previous %}
          <li><a href="?page={{ posts.previous_page_number }}">&laquo;</a></li>
        {% else %}
          <li class="disabled"><span>&laquo;</span></li>
        {% endif %}
        {% for i in posts.paginator.page_range %}
          {% if posts.number == i %}
            <li class="active"><span>{{ i }}</span></li>
          {% else %}
            <li><a href="?page={{ i }}">{{ i }}</a></li>
          {% endif %}
        {% endfor %}
        {% if posts.has_next %}
          <li><a href="?page={{ posts.next_page_number }}">&raquo;</a></li>
        {% else %}
          <li class="disabled"><span>&raquo;</span></li>
        {% endif %}
      </ul>
    {% endif %}
{% endblock %}

{% block sidebar %}
    <div>
        <h3>{% trans "Теги" %}</h3>
        <div class="block">
            {% for tag in tags_cloud %}
                <a href="{% url 'tag_list' tags=tag.name %}" class="tag-size-{{ tag.font_size }}">{{ tag.name }}</a>
            {% endfor %}
        </div>
    </div>
{% endblock %}
