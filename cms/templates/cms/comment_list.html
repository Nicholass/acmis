{% load i18n %}
{% load mptt_tags %}
{% load auth %}
{% load thumbnail %}

<ul>
    {% recursetree comments %}
        <li>
            <div class="comment{% if node.is_deleted %} deleted{% endif %}" id="comment{{ node.pk }}">
                {% if not node.is_deleted %}
                    <div class="user">
                        <a href="{% url 'another_profile' username=node.author.username %}" >
                            <i class="fa fa-user"></i>
                            {{ node.author }}
                        </a>
                        <br>
                        {% if node.author.profile.avatar %}
                            {% thumbnail base_path|add:node.author.profile.avatar.url AVATAR_DIMENSIONS as avatar %}
                                <img src="{{ avatar.url }}" alt="{{ user_profile.get_display_name }} avatar"/>
                            {% endthumbnail %}
                        {% else %}
                            <img src="{{ AVATAR_DEFAULT }}" alt="default avatar" width="{{ AVATAR_MAX_WIDTH }}" height="{{ AVATAR_MAX_HEIGHT }}"/>
                        {% endif %}
                        <p class="user-actions">
                            <a href="{% url 'messages_compose_to' recipient=node.author %}">{% trans 'ЛС' %}</a>
                        </p>
                    </div>
                    <div class="text">
                        <p class="info">
                            <i class="fa fa-calendar"></i> {{ node.created_date }}
                        </p>
                        <p>
                            {{ node.text|linebreaksbr }}
                            {% if node.modifed_date %}
                                <br />
                                <br />
                                <i class="edit-notice">{% trans "Отредактирован " %} {{ node.modifed_date }}</i>
                            {% endif %}
                        </p>
                        <p class="actions">
                            {% auth_is_owner node as is_comment_owner %}
                            {% if user.is_authenticated %}
                                {% if perms.cms.add_comment %}
                                    <a href="{% url 'comment_reply' pk=post.pk cpk=node.pk %}">
                                        <i class="fa fa-comment"></i>
                                        {% trans "Ответ" %}
                                    </a>
                                {% endif %}
                                {% if perms.cms.change_comment and is_comment_owner %}
                                    <a href="{% url 'comment_edit' pk=post.pk cpk=node.pk %}">
                                        <i class="fa fa-edit"></i>
                                        {% trans "Редактировать" %}
                                    </a>
                                {% endif %}
                                {% if perms.cms.delete_comment and is_comment_owner %}
                                    <a href="{% url 'comment_delete' pk=post.pk cpk=node.pk %}" onclick="return confirm('{% trans "Вы уверены, что хотите удалить комментарий? Отменить это действие будет невозможно." %}')">
                                        <i class="fa fa-trash"></i>
                                        {% trans "Удалить" %}
                                    </a>
                                {% endif %}
                            {% endif %}
                            <a href="{% url 'post_detail' pk=post.pk %}#comment{{ node.pk }}">
                                <i class="fa fa-link"></i>
                                {% trans "Ссылка" %}
                            </a>
                        </p>
                    </div>
                {% else %}
                    <p class="media-content">
                        <i>Комментарий был удален</i>
                    </p>
                {% endif %}
            </div>

            {% if not node.is_leaf_node %}
                <ul class="thread">
                    {{ children }}
                </ul>
            {% endif %}
        </li>
    {% endrecursetree %}
</ul>