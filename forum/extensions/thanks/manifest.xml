<?xml version="1.0" encoding="utf-8"?>
<!-- /* * manifest file for thanks * * @copyright Copyright (C) KANekT @ 
	http://blog.kanekt.ru * @license http://www.gnu.org/licenses/gpl.html GPL 
	version 2 or higher * Donate Web Money Z104136428007 R346491122688 * @package 
	thanks */ -->
<extension engine="1.0">
	<id>thanks</id>
	<title>thanks</title>
	<version>0.6.1</version>
	<description>This extension lets your members thank someone for a post
		they posted.
	</description>
	<author>KANekT (improved by Ghost)</author>
	<minversion>1.3</minversion>
	<maxtestedon>1.3.4</maxtestedon>

	<install><![CDATA[
require_once FORUM_ROOT.'extensions/thanks/install.php';
install();

]]></install>
	<uninstall><![CDATA[
require_once FORUM_ROOT.'extensions/thanks/install.php';
uninstall();

]]></uninstall>

	<hooks>
		<hook id="co_common"><![CDATA[
			$pun_extensions_used = array_merge(isset($pun_extensions_used) ? $pun_extensions_used : array(), array($ext_info['id']));
		]]></hook>
		<hook id="co_modify_url_scheme">
			<![CDATA[
				// Setup the URL rewriting scheme
				if (file_exists($ext_info['path'].'/url/'.$forum_config['o_sef'].'.php'))
					require $ext_info['path'].'/url/'.$forum_config['o_sef'].'.php';
				else
					require $ext_info['path'].'/url/Default.php';
			]]>
		</hook>
		<hook id="re_rewrite_rules"><![CDATA[
			$forum_rewrite_rules['/^thanks_user[\/_-]?([0-9]+)(\.html?|\/)?$/i'] = 'misc.php?section=thanks&uid=$1';
			$forum_rewrite_rules['/^thanks_user[\/_-]?([0-9a-z]+)[\/_-]?(p|page\/)([0-9]+)(\.html?|\/)?$/i'] = 'misc.php?section=thanks&uid=$1&p=$3';
		]]></hook>
		<hook id="hd_head"><![CDATA[
if (FORUM_PAGE == 'viewtopic')
{
	if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'.php'))
		require $ext_info['path'].'/lang/'.$forum_user['language'].'.php';
	else
		require $ext_info['path'].'/lang/English.php';

	$ape = 'var base_url_thanks = \''.$base_url.'\';';
/*	
	if ($forum_config['o_thanks_view'] == '1')
	{
		$forum_head['apk_css'] = '<style>
		.spoiler_nnn{
			background: #daa520;
			border: 3px dashed navy;
			display: none;
		}
		</style>';
	}
*/
	$forum_head['apk_js'] = '<script type="text/javascript" src="'.$ext_info['url'].'/ajax_thanks_full.js"></script>';
	$forum_head['apk_js2'] = '<script type="text/javascript">'."\n".$ape."\n".'</script>';
}
					     ]]></hook>

		<hook id="vt_row_pre_post_actions_merge"><![CDATA[
                      if ($forum_config['o_thanks_view'] == '1') {
			$say_thanks = sprintf($lang_thanks['Say thanks'], $cur_post['username']);

            //1209600 == 2 weeks  
			if ($forum_user['id'] != 1 AND $forum_user['id'] != $cur_post['poster_id'] AND !$cur_post['tId'] > 0 AND (time() - $cur_post['posted'] < 1209600))
			{
				$forum_page['post_actions']['thanks'] = '<span id="button_t'.$cur_post['id'].'"><a id="thanks_button'.$cur_post['id'].'" href="javascript:thank('.$cur_post['id'].')" title="'.$say_thanks.'" rel="nofollow">'.$lang_thanks['SayThanks'].'</a></span>';
			}
                      }
		]]>
		</hook>
		<hook id="vt_row_pre_display"><![CDATA[
				if ($forum_config['o_thanks_view'] == '1')
				{
					$forum_page['message']['spoiler'] = '
					<div class="quotebox" id="spoiler_caption'.$cur_post['id'].'" style="'. ($cur_post['pThanks'] == 0 ? 'display:none' : '') .'">
						<b>+'.$cur_post['pThanks'].' </b><a id="thanks'.$cur_post['id'].'" href="javascript:thanksSpoiler('.$cur_post['id'].')" title="" rel="nofollow">('.$lang_thanks['ThanksListView'].')</a>
					</div>
					<div style="clear: both"></div>
					<div id="spoiler_text'.$cur_post['id'].'" class="quotebox" style="display:none"></div>';
				}
			]]>
		</hook>
		<hook id="vt_qr_get_posts"><![CDATA[
				$query['SELECT'] .= ', p.thanks as pThanks, ts.id as tId';
				$query['JOINS'][] = array(
					'LEFT JOIN'	=> 'thanks AS ts',
					'ON'		=> '(p.id=ts.post_id AND ts.user_thanked_id = '.$forum_user['id'].')'
				);
			]]>
		</hook>
		<hook id="mi_new_action"><![CDATA[
		$section = isset($_GET['section']) ? $_GET['section'] : null;

		require_once $ext_info['path'].'/functions.php';
		
		if ($action == 'thank') {
			
		if (file_exists(FORUM_ROOT.'extensions/thanks/lang/'.$forum_user['language'].'.php'))
			require FORUM_ROOT.'extensions/thanks/lang/'.$forum_user['language'].'.php';
		else
			require FORUM_ROOT.'extensions/thanks/lang/English.php';
			
		/*$user_id = (isset($_POST['user'])) ? intval($_POST['user']) : '';
		$post_id = (isset($_POST['post'])) ? intval($_POST['post']) : '';
		$user_thanked_id = (isset($_POST['user_t'])) ? intval($_POST['user_t']) : '';
		*/
		$user_id = (isset($_GET['user'])) ? intval($_GET['user']) : '';
		$post_id = (isset($_GET['post'])) ? intval($_GET['post']) : '';
		$user_thanked_id = (isset($_GET['user_t'])) ? intval($_GET['user_t']) : '';
		
		thank($post_id);
		
		exit;
		}
		
		if ($action == 'thanks_spoiler') {
		  $post_id = (isset($_GET['po'])) ? intval($_GET['po']) : '';
		  show_thanks($post_id);
		}

		]]></hook>
		<hook id="aop_features_validation"><![CDATA[
			if (!isset($form['thanks_view']) || $form['thanks_view'] != '1') $form['thanks_view'] = '0';
		]]></hook>

		<hook id="aop_features_pre_general_fieldset_end"><![CDATA[
				if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'.php'))
					require $ext_info['path'].'/lang/'.$forum_user['language'].'.php';
				else
					require $ext_info['path'].'/lang/English.php';
?>
			<div class="sf-set set<?php echo ++$forum_page['item_count'] ?>">
				<div class="sf-box checkbox">
					<span class="fld-input"><input type="checkbox" id="fld<?php echo ++$forum_page['fld_count'] ?>" name="form[thanks_view]" value="1"<?php if ($forum_config['o_thanks_view'] == '1') echo ' checked="checked"' ?> /></span>
					<label for="fld<?php echo $forum_page['fld_count'] ?>"><span><?php echo $lang_thanks['Thanks label'] ?></span> <?php echo $lang_thanks['Thanks desc'] ?></label>
				</div>
			</div>
<?php
		]]></hook>
                <hook id="ed_pre_redirect"><![CDATA[

                    if ((!$forum_page['is_admmod'] || ($forum_user['id'] == $cur_post['poster_id']))) {
                        // Clear thanks
                        $query = array(
                                'UPDATE'	=> 'posts',
                                'SET'		=> 'thanks=0',
                                'WHERE'		=> 'id='.$id
                        );

                        $forum_db->query_build($query) or error(__FILE__, __LINE__);

                        $query = array(
                                'DELETE'	=> 'thanks',
                                'WHERE'		=> 'post_id='.$id
                        );

                        $forum_db->query_build($query) or error(__FILE__, __LINE__);
                    }
                ]]></hook>
                <hook id="fancy_merge_pre_redirect"><![CDATA[
                     if ((!$forum_page['is_admmod'] || ($forum_user['id'] == $cur_posting['poster_id']))) {
                        // Clear thanks
                        $query = array(
                                'UPDATE'	=> 'posts',
                                'SET'		=> 'thanks=0',
                                'WHERE'		=> 'id='.$cur_posting['post_id']
                        );

                        $forum_db->query_build($query) or error(__FILE__, __LINE__);

                        $query = array(
                                'DELETE'	=> 'thanks',
                                'WHERE'		=> 'post_id='.$cur_posting['post_id']
                        );

                        $forum_db->query_build($query) or error(__FILE__, __LINE__);
                    }
                ]]></hook>
	</hooks>

</extension>
