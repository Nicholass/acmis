<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE extension SYSTEM "ext-1.0.dtd">

<extension engine="1.0">
	<id>fancy_pm_notification</id>
	<title>Fancy Private Message Notification</title>
	<version>0.3.4</version>
	<description>Показывает чудесное всплывающее окошко при приходе новых ЛС</description>
	<author>dimka.linux@gmail.com</author>

	<minversion>1.3dev</minversion>
	<maxtestedon>1.3.4</maxtestedon>

	<dependencies>
		<dependency>jquery</dependency>
		<dependency>pun_pm</dependency>
	</dependencies>


	<hooks>
		<hook id="mi_new_action"><![CDATA[
			if ($action == 'fancy_pm_notification_get_unread') {
				include_once FORUM_ROOT.'extensions/pun_pm/functions.php';
				include_once $ext_info['path'].'/functions.php';

				$pun_pm_get_unread_Result = 0;
				$pun_pm_get_unread_Message = 0;

				do {
					if (!isset($forum_user) || $forum_user['is_guest']) {
						$pun_pm_get_unread_Message = 0;
						break;
					}

					$pun_pm_get_unread_Message = fancy_pm_notification_get_unread_count();
					$pun_pm_get_unread_Result = 1;
				} while(0);

				if (function_exists('json_encode')) {
					exit(json_encode(array('result'=>$pun_pm_get_unread_Result, 'count'=>$pun_pm_get_unread_Message)));
				} else {
					exit('{"result":'.$pun_pm_get_unread_Result.',"count":'.$pun_pm_get_unread_Message.'}');
				}
			}
		]]></hook>


		<hook id="hd_head"><![CDATA[
			if (!$forum_user['is_guest']) {
				if (FORUM_PAGE == 'viewtopic' || FORUM_PAGE == 'viewforum' || FORUM_PAGE == 'index' || FORUM_PAGE == 'search' ||  FORUM_PAGE == 'post') {
					if (file_exists($ext_info['path'].'/styles/'.$forum_user['style'].'/')) {
						$forum_head['fancy_pm_notification_css'] = '<link rel="stylesheet" type="text/css" media="screen" href="'.$ext_info['url'].'/styles/'.$forum_user['style'].'/style.css" />';
					} else {
						$forum_head['fancy_pm_notification_css'] = '<link rel="stylesheet" type="text/css" media="screen" href="'.$ext_info['url'].'/styles/Oxygen/style.css" />';
					}

					$forum_head['fancy_pm_notification_url_js'] = '<script type="text/javascript">
						var fancy_pm_notification_misc_url = "'.$base_url.'/misc.php";
					</script>';

					$forum_head['fancy_pm_notification_js'] = '<script type="text/javascript" src="'.$ext_info['url'].'/jquery.jgrowl.js"></script>';

					$forum_head['fancy_pm_notification_run_js'] = '<script type="text/javascript">
						jQuery(function ($) {
							fancy_pm_notification_async();
							//$("body").everyTime("45s", "fancy_pm_notification_get_unread", fancy_pm_notification_async);
						});
				 	</script>';
				} else if (FORUM_PAGE == 'pun_pm-inbox') {
					include_once $ext_info['path'].'/functions.php';
					$pun_pm_get_unread_Message = fancy_pm_notification_get_unread_count();
					setcookie("fancy_pm_notification_unread", $pun_pm_get_unread_Message, (time() + 3600000), '/');
				}
			}
		]]></hook>

		<hook id="li_logout_pre_redirect,li_login_pre_redirect"><![CDATA[
			setcookie("fancy_pm_notification_unread", 0, (time() - 3600000), '/');
		]]></hook>
	</hooks>
</extension>
