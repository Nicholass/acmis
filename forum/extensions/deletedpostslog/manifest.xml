<?xml version="1.0" encoding="utf-8"?>

<extension engine="1.0">
	<id>deletedpostslog</id>
	<title>Deleted Posts Log</title>
	<version>3.2b</version>
	<description>This extension provides a log of all deleted posts and the ability to restore these posts or delete them forever.</description>
	<author>Franz Liedke</author>
	<minversion>1.3 Beta</minversion>
	<maxtestedon>1.3 Beta</maxtestedon>
  
	<note type="install">You will find the log under "Management - Deleted Posts Log".</note>
	<note type="install">New in this version: minor enhancements and compatibility with changeset 1611.</note>
	<note type="uninstall">All posts and topics that were marked as deleted and not restored by this extension until now will be deleted forever. You will not be able to restore them if you choose to reinstall "Deleted Posts Log"!</note>
	
	<install>
		<![CDATA[
		$forum_db->add_field($forum_db->prefix.'posts', 'deleted', 'tinyint(1)', false, 0, 'edited_by');
		$forum_db->add_field($forum_db->prefix.'posts', 'deleter_id', 'int(10)', true, NULL, 'deleted');
		$forum_db->add_field($forum_db->prefix.'posts', 'deleted_when', 'int(10)', true, NULL, 'deleter_id');
		$forum_db->add_field($forum_db->prefix.'topics', 'deleted', 'tinyint(1)', false, 0, 'last_poster');
		$forum_db->add_field($forum_db->prefix.'subscriptions', 'deleted', 'tinyint(1)', false, 0, 'topic_id');
		$forum_db->query('DELETE FROM '.$forum_db->prefix.'config WHERE conf_name LIKE \'deletedpostslog%\'');
		$forum_db->query('INSERT INTO '.$forum_db->prefix.'config VALUES(\'deletedpostslog_parselog\', 1)');
		$forum_db->query('INSERT INTO '.$forum_db->prefix.'config VALUES(\'deletedpostslog_numshowposts\', 10)');
		$forum_db->query('INSERT INTO '.$forum_db->prefix.'config VALUES(\'deletedpostslog_sortbydate\', 0)');
		]]>
	</install>

	<uninstall>
		<![CDATA[
		$forum_db->query('DELETE FROM '.$forum_db->prefix.'posts WHERE deleted=1');
		$forum_db->query('DELETE FROM '.$forum_db->prefix.'topics WHERE deleted=1');
		$forum_db->query('DELETE FROM '.$forum_db->prefix.'subscriptions WHERE deleted=1');
		$forum_db->query('DELETE FROM '.$forum_db->prefix.'config WHERE conf_name LIKE \'deletedpostslog%\'');
		$forum_db->drop_field($forum_db->prefix.'posts', 'deleted');
		$forum_db->drop_field($forum_db->prefix.'posts', 'deleter_id');
		$forum_db->drop_field($forum_db->prefix.'posts', 'deleted_when');
		$forum_db->drop_field($forum_db->prefix.'topics', 'deleted');
		$forum_db->drop_field($forum_db->prefix.'subscriptions', 'deleted');
		]]>
	</uninstall>

	<hooks>
		<hook id="dl_qr_get_post_info">
			<![CDATA[
			$query['WHERE'] .= ' AND p.deleted=0';
			]]>
		</hook>
		<hook id="ed_qr_get_post_info">
			<![CDATA[
			$query['WHERE'] .= ' AND p.deleted=0';
			]]>
		</hook>
		<hook id="ex_qr_get_topic_data">
			<![CDATA[
			$query['WHERE'] .= ' AND t.deleted=0';
			]]>
		</hook>
		<hook id="ex_qr_get_posts">
			<![CDATA[
			$query['WHERE'] .= ' AND p.deleted=0';
			]]>
		</hook>
		<hook id="ex_qr_get_topics">
			<![CDATA[
			$query['WHERE'] .= ' AND t.deleted=0';
			]]>
		</hook>
		<hook id="mi_report_qr_get_topic_data">
			<![CDATA[
			$query['WHERE'] .= ' AND p.deleted=0';
			]]>
		</hook>
		<hook id="mi_subscribe_qr_topic_exists">
			<![CDATA[
			$query['WHERE'] .= ' AND t.deleted=0';
			]]>
		</hook>
		<hook id="mr_view_ip_qr_get_poster_ip">
			<![CDATA[
			$query['WHERE'] .= ' AND p.deleted=0';
			]]>
		</hook>
		<hook id="mr_post_actions_qr_get_topic_info">
			<![CDATA[
			$query['WHERE'] .= ' AND t.deleted=0';
			]]>
		</hook>
		<hook id="mr_confirm_delete_topics_qr_verify_topic_ids">
			<![CDATA[
			$query['WHERE'] .= ' AND t.deleted=0';
			]]>
		</hook>
		<hook id="mr_confirm_delete_topics_qr_get_forums_to_sync">
			<![CDATA[
			$query['WHERE'] .= ' AND t.deleted=0';
			]]>
		</hook>
		<hook id="mr_confirm_delete_posts_qr_verify_post_ids">
			<![CDATA[
			$query['WHERE'] .= ' AND p.deleted=0';
			]]>
		</hook>
		<hook id="mr_confirm_split_posts_qr_verify_post_ids">
			<![CDATA[
			$query['WHERE'] .= ' AND p.deleted=0';
			]]>
		</hook>
		<hook id="mr_confirm_delete_posts_qr_delete_posts">
			<![CDATA[
			unset($query['DELETE']);
			$query['UPDATE'] = 'posts';
			$query['SET'] = 'deleted=1, deleter_id='.$forum_user['id'].', deleted_when='.time();
			]]>
		</hook>
		<hook id="mr_qr_get_topic_last_post_data">
			<![CDATA[
			$query['WHERE'] .= ' AND p.deleted=0';
			]]>
		</hook>
		<hook id="mr_post_actions_qr_get_posts">
			<![CDATA[
			$query['WHERE'] .= ' AND p.deleted=0';
			]]>
		</hook>
		<hook id="mr_confirm_move_topics_qr_verify_topic_ids">
			<![CDATA[
			$query['WHERE'] .= ' AND t.deleted=0';
			]]>
		</hook>
		<hook id="mr_confirm_merge_topics_qr_verify_topic_ids">
			<![CDATA[
			$query['WHERE'] .= ' AND t.deleted=0';
			]]>
		</hook>
		<hook id="mr_confirm_delete_topics_qr_delete_topics">
			<![CDATA[
			unset($query['DELETE']);
			$query['UPDATE'] = 'topics';
			$query['SET'] = 'deleted=1';
			]]>
		</hook>
		<hook id="mr_confirm_delete_topics_qr_delete_subscriptions">
			<![CDATA[
			unset($query['DELETE']);
			$query['UPDATE'] = 'subscriptions';
			$query['SET'] = 'deleted=1';
			]]>
		</hook>
		<hook id="mr_confirm_merge_topics_qr_delete_subscriptions">
			<![CDATA[
			unset($query['DELETE']);
			$query['UPDATE'] = 'subscriptions';
			$query['SET'] = 'deleted=1';
			]]>
		</hook>
		<hook id="mr_confirm_delete_topics_qr_delete_topic_posts">
			<![CDATA[
			unset($query['DELETE']);
			$query['UPDATE'] = 'posts';
			$query['SET'] = 'deleted=1, deleter_id='.$forum_user['id'].', deleted_when='.time();
			]]>
		</hook>
		<hook id="mr_qr_get_topics">
			<![CDATA[
			$query['WHERE'] .= ' AND t.deleted=0';
			]]>
		</hook>
		<hook id="po_qr_get_forum_info">
			<![CDATA[
			if ($tid)
				$query['WHERE'] .= ' AND t.deleted=0';
			]]>
		</hook>
		<hook id="po_qr_get_quote">
			<![CDATA[
			$query['WHERE'] .= ' AND p.deleted=0';
			]]>
		</hook>
		<hook id="po_topic_review_qr_get_topic_review_posts">
			<![CDATA[
			$query['WHERE'] .= ' AND p.deleted=0';
			]]>
		</hook>
		<hook id="sf_fn_create_search_cache_qr_get_author_hits">
			<![CDATA[
			$query['WHERE'] .= ' AND p.deleted=0';
			]]>
		</hook>
		<hook id="sf_fn_create_search_cache_qr_get_hits">
			<![CDATA[
			$query['WHERE'] .= ' AND p.deleted=0';
			]]>
		</hook>
		<hook id="sf_fn_generate_cached_search_query_qr_get_cached_hits_as_posts">
			<![CDATA[
			$query['WHERE'] .= ' AND p.deleted=0';
			]]>
		</hook>
		<hook id="sf_fn_generate_cached_search_query_qr_get_cached_hits_as_topics">
			<![CDATA[
			$query['WHERE'] .= ' AND t.deleted=0';
			]]>
		</hook>
		<hook id="sf_fn_generate_action_search_query_qr_get_new">
			<![CDATA[
			$query['WHERE'] .= ' AND t.deleted=0';
			]]>
		</hook>
		<hook id="sf_fn_generate_action_search_query_qr_get_recent">
			<![CDATA[
			$query['WHERE'] .= ' AND t.deleted=0';
			]]>
		</hook>
		<hook id="sf_fn_generate_action_search_query_qr_get_user_posts">
			<![CDATA[
			$query['WHERE'] .= ' AND p.deleted=0';
			]]>
		</hook>
		<hook id="sf_fn_generate_action_search_query_qr_get_user_topics">
			<![CDATA[
			$query['WHERE'] .= ' AND p.deleted=0';
			]]>
		</hook>
		<hook id="sf_fn_generate_action_search_query_qr_get_subscriptions">
			<![CDATA[
			$query['WHERE'] .= ' AND t.deleted=0';
			]]>
		</hook>
		<hook id="sf_fn_generate_action_search_query_qr_get_unanswered">
			<![CDATA[
			$query['WHERE'] .= ' AND t.deleted=0';
			]]>
		</hook>
		<hook id="xn_fulltext_qr_get_cached_hits_as_posts">
			<![CDATA[
			$query['WHERE'] .= ' AND p.deleted=0';
			]]>
		</hook>
		<hook id="xn_fulltext_subqr_get_cached_hits_as_topics">
			<![CDATA[
			$subquery1['WHERE'] .= ' AND t.deleted=0';
			$subquery2['WHERE'] .= ' AND t.deleted=0';
			]]>
		</hook>
		<hook id="vf_qr_get_topics">
			<![CDATA[
			$query['WHERE'] .= ' AND t.deleted=0';
			if (!$forum_user['is_guest'] && $forum_config['o_show_dot'] == '1')
				$query['JOINS'][0]['ON'] .= ' AND p.deleted=0';
			]]>
		</hook>
		<hook id="vt_qr_get_post_info">
			<![CDATA[
			$query['WHERE'] .= ' AND p.deleted=0';
			]]>
		</hook>
		<hook id="vt_qr_get_post_page">
			<![CDATA[
			$query['WHERE'] .= ' AND p.deleted=0';
			]]>
		</hook>
		<hook id="vt_qr_get_first_new_post">
			<![CDATA[
			$query['WHERE'] .= ' AND p.deleted=0';
			]]>
		</hook>
		<hook id="vt_qr_get_posts">
			<![CDATA[
			$query['WHERE'] .= ' AND p.deleted=0';
			]]>
		</hook>
		<hook id="vt_qr_get_topic_info">
			<![CDATA[
			$query['WHERE'] .= ' AND t.deleted=0';
			]]>
		</hook>
		<hook id="fn_sync_forum_qr_get_forum_stats">
			<![CDATA[
			$query['WHERE'] .= ' AND t.deleted=0';
			]]>
		</hook>
		<hook id="fn_sync_forum_qr_get_forum_last_post_data">
			<![CDATA[
			$query['WHERE'] .= ' AND t.deleted=0';
			]]>
		</hook>
		<hook id="fn_qr_get_topic_reply_count2">
			<![CDATA[
			$query['WHERE'] .= ' AND p.deleted=0';
			]]>
		</hook>
		<hook id="fn_sync_topic_qr_get_topic_reply_count">
			<![CDATA[
			$query['WHERE'] .= ' AND p.deleted=0';
			]]>
		</hook>
		<hook id="fn_add_post_qr_get_topic_reply_count">
			<![CDATA[
			$query['WHERE'] .= ' AND p.deleted=0';
			]]>
		</hook>
		<hook id="fn_sync_topic_qr_get_topic_last_post_data">
			<![CDATA[
			$query['WHERE'] .= ' AND p.deleted=0';
			]]>
		</hook>
		<hook id="fn_delete_topic_start">
			<![CDATA[
			global $forum_user;
			]]>
		</hook>
		<hook id="fn_delete_topic_qr_delete_topic">
			<![CDATA[
				unset($query['DELETE']);
				$query['UPDATE'] = 'topics';
				$query['SET'] = 'deleted=1';
			]]>
		</hook>
		<hook id="fn_delete_topic_qr_get_posts_to_delete">
			<![CDATA[
			$query['WHERE'] .= ' AND p.deleted=0';
			]]>
		</hook>
		<hook id="fn_delete_topic_qr_delete_topic_posts">
			<![CDATA[
				unset($query['DELETE']);
				$query['UPDATE'] = 'posts';
				$query['SET'] = 'deleted=1, deleter_id='.$forum_user['id'].', deleted_when='.time();
			]]>
		</hook>
		<hook id="fn_delete_topic_qr_delete_topic_subscriptions">
			<![CDATA[
				unset($query['DELETE']);
				$query['UPDATE'] = 'subscriptions';
				$query['SET'] = 'deleted=1';
			]]>
		</hook>
		<hook id="fn_delete_post_start">
			<![CDATA[
			global $forum_user;
			
			$query = array(
				'SELECT'	=> 'p.poster_id',
				'FROM'		=> 'posts AS p',
				'WHERE'		=> 'p.id='.$post_id,
				'LIMIT'		=> '1'
			);
	
			$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);
			list($poster_id) = $forum_db->fetch_row($result);

			]]>
		</hook>
		<hook id="fn_qr_get_topic_lastposts_info">
			<![CDATA[
			$query['WHERE'] .= ' AND p.deleted=0';
			]]>
		</hook>
		<hook id="fn_delete_post_qr_delete_post">
			<![CDATA[
			if ($poster_id != $forum_user['id']) {
				unset($query['DELETE']);
				$query['UPDATE'] = 'posts';
				$query['SET'] = 'deleted=1, deleter_id='.$forum_user['id'].', deleted_when='.time();
			}
			]]>
		</hook>
		<hook id="fn_send_subscriptions_qr_get_previous_post_time">
			<![CDATA[
			$query['WHERE'] .= ' AND p.deleted=0';
			]]>
		</hook>
		<hook id="ca_fn_generate_admin_menu_new_sublink">
			<![CDATA[
			if ($forum_user['g_id'] == FORUM_ADMIN)
			{
				if (FORUM_PAGE_SECTION == 'management')
					$forum_page['admin_submenu']['deleted_posts_log'] = '<li class="'.((FORUM_PAGE == 'admin-management-manage_deletedpostslog') ? 'active' : 'normal').((empty($forum_page['admin_menu'])) ? ' first-item' : '').'"><a href="'.$ext_info['url'].'/postslog.php">Deleted Posts Log</a></li>';
			} else {
				$forum_page['admin_submenu']['deleted_posts_log'] = '<li class="'.((FORUM_PAGE == 'admin-management-manage_deletedpostslog') ? 'active' : 'normal').((empty($forum_page['admin_menu'])) ? ' first-item' : '').'"><a href="'.$ext_info['url'].'/postslog.php">Deleted Posts Log</a></li>';
			}
			]]>
		</hook>
		<hook id="apr_pre_prune_fieldset">
			<![CDATA[
			?>
			<div class="frm-info">
				<p class="warn"><strong>WARNING!</strong> Pruned topics will not be stored in the Deleted Posts Log.</p>
			</div>
			<?php
			]]>
		</hook>
		<hook id="nw_pre_header_load">
			<![CDATA[
			$query['WHERE'] .= ' AND p.deleted=0';
			]]>
		</hook>
	</hooks>
</extension>