<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE extension SYSTEM "ext-1.0.dtd">

<!--
/*
	Copyright (C) 2008 Garciat (Gabriel Garcia T.) <http://garciat.org/>
	Released under GPL license version 3 or any later version <http://www.gnu.org/licenses/gpl.html>
	
	This extension is free software: you can redistribute it and/or modify
	it under the terms of the GNU General Public License as published by
	the Free Software Foundation, either version 3 of the License, or
	(at your option) any later version.

	This extension is distributed in the hope that it will be useful,
	but WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
	GNU General Public License for more details.

	You should have received a copy of the GNU General Public License
	along with this extension.  If not, see <http://www.gnu.org/licenses/>.
*/
-->

<extension engine="1.0">
	<id>userinfo</id>
	<title>Show (Some) User info</title>
	<version>1.0.2</version>
	<description>Lets you decide what user info to show.</description>
	<author>Garciat</author>
	<minversion>1.3</minversion>
	<maxtestedon>1.3.2</maxtestedon>
	
	<install>
		<![CDATA[
	$def_config = $forum_config['o_show_user_info'];
	
	$new_config = array(
		'o_userinfo_location'	=> $def_config,
		'o_userinfo_register'	=> $def_config,
		'o_userinfo_posts'		=> $def_config,
		'o_userinfo_email'		=> $def_config,
		'o_userinfo_url'		=> $def_config,
		'o_userinfo_title'		=> $def_config,
		'o_userinfo_status'		=> $def_config
	);

	foreach($new_config as $key => $value)
	{
		if (!isset($forum_config[$key]))
		{
			$query = array(
				'INSERT'	=> 'conf_name, conf_value',
				'INTO'		=> 'config',
				'VALUES'	=> '\''.$key.'\', \''.$value.'\''
			);
			$forum_db->query_build($query) or error(__FILE__, __LINE__);
		}
	}
		]]>
	</install>
	
	<uninstall>
		<![CDATA[
$new_config = array(
	'o_userinfo_location',
	'o_userinfo_register',
	'o_userinfo_posts',
	'o_userinfo_email',
	'o_userinfo_url',
	'o_userinfo_title',
	'o_userinfo_status'
);

$query = array(
	'DELETE'	=> 'config',
	'WHERE'		=> 'conf_name in (\''.implode("', '", $new_config).'\')',
);
$forum_db->query_build($query) or error(__FILE__, __LINE__);
		]]>
	</uninstall>
	
	<hooks>
		<hook id="vt_row_pre_post_contacts_merge">
			<![CDATA[
if(!$forum_config['o_userinfo_location'])
	unset($forum_page['author_info']['from']);

if(!$forum_config['o_userinfo_register'])
	unset($forum_page['author_info']['registered']);

if(!$forum_config['o_userinfo_posts'])
	unset($forum_page['author_info']['posts']);

if(!$forum_config['o_userinfo_email'])
	unset($forum_page['post_contacts']['email']);

if(!$forum_config['o_userinfo_url'])
	unset($forum_page['post_contacts']['url']);

if(!$forum_config['o_userinfo_title'])
	unset($forum_page['author_ident']['usertitle']);

if(!$forum_config['o_userinfo_status'])
	unset($forum_page['author_ident']['status']);
			]]>
		</hook>
		<hook id="aop_features_validation">
			<![CDATA[
$userinfo_options = array(
	'userinfo_location',
	'userinfo_register',
	'userinfo_posts',
	'userinfo_email',
	'userinfo_url',
	'userinfo_title',
	'userinfo_status'
);

foreach($userinfo_options as $v)
	$form[$v] = isset($form[$v]) ? '1' : '0';

$form['show_user_info'] = '1';
			]]>
		</hook>
		<hook id="aop_features_pre_show_user_info_checkbox">
			<![CDATA[
ob_start();
			]]>
		</hook>
		<hook id="aop_features_pre_posting_fieldset_end" priority="1">
			<![CDATA[
ob_end_clean();

if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php'))
	include $ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php';
else
	include $ext_info['path'].'/lang/English/'.$ext_info['id'].'.php';

$forum_page['item_count']--; $forum_page['fld_count']--;

?>
				<fieldset class="mf-set set<?php echo ++$forum_page['item_count'] ?>">
					<legend><span><?php echo $lang_admin_settings['User info'] ?></span></legend>
					<div class="mf-box">
						<div class="checklist">
<?php

$userinfo_options = array(
	'userinfo_title'		=> $lang_userinfo['Title'],
	'userinfo_status'		=> $lang_userinfo['Status'],
	'userinfo_location'		=> $lang_userinfo['Location'],
	'userinfo_register'		=> $lang_userinfo['Register'],
	'userinfo_posts'		=> $lang_userinfo['Posts'],
	'userinfo_email'		=> $lang_userinfo['Email'],
	'userinfo_url'			=> $lang_userinfo['URL']
);

foreach ($userinfo_options as $k=>$v)
{
	echo "\t\t\t\t\t\t\t\t".'<div class="checklist-item"><span class="fld-input"><input type="checkbox" id="fld'.(++$forum_page['fld_count']).'"  name="form['.$k.']" value="1"'.(($forum_config['o_'.$k] == '1') ? ' checked="checked"' : '').' /></span> <label for="fld'.$forum_page['fld_count'].'">'.forum_htmlencode($v).'</label></div>'."\n";
}

?>
						</div>
					</div>
				</fieldset>
<?php
			]]>
		</hook>
	</hooks>
</extension>