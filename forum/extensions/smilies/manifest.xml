<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE extension SYSTEM "ext-1.0.dtd">

<!--
/*
	Copyright (C) 2008 Garciat (Gabriel Garcia T.) <http://garciat.us.to/>
	Released under GPL license version 3 or any later version <http://www.gnu.org/licenses/gpl.html>
	
	This extension is free software: you can redistribute it and/or modify
	it under the terms of the GNU General Public License as published by
	the Free Software Foundation, either version 3 of the License, or
	(at your option) any later version.

	This extension is distributed in the hope that it will be useful,
	but WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
	GNU General Public License for more details.

	You should have received a copy of the GNU General Public License
	along with this extension.  If not, see <http://www.gnu.org/licenses/>.
*/
-->

<extension engine="1.0">
	<id>smilies</id>
	<title>Smilies</title>
	<version>1.0</version>
	<description>Integrates an improved smilies system.</description>
	<author>Garciat</author>
	<minversion>1.3</minversion>
	<maxtestedon>1.3.2</maxtestedon>
	
	<note type="install" timing="pre">Warning: web server should have write access to your smilies directory (img/smilies/).</note>
	
	<install>
		<![CDATA[
if(!defined('EXT_CUR_VERSION'))
{
	//Create 'default' folder inside smilies folder
	mkdir(FORUM_ROOT.'img/smilies/default');
	
	//Copy default smilies to the 'default' folder
	$default_smilies = array("big_smile", "cool", "hmm", "lol", "mad", "neutral", "roll", "sad", "smile", "tongue", "wink", "yikes");
	foreach($default_smilies as $name) copy(FORUM_ROOT.'img/smilies/'.$name.'.png', FORUM_ROOT.'img/smilies/default/'.$name.'.png');
	
	//Copy index.html for security
	copy(FORUM_ROOT.'img/smilies/index.html', FORUM_ROOT.'img/smilies/default/index.html');
	
	//Write the set's manifest
	require $ext_info['path'].'/functions.php';
	$combos = array(':)' => 'smile.png', '=)' => 'smile.png', ':|' => 'neutral.png', '=|' => 'neutral.png', ':(' => 'sad.png', '=(' => 'sad.png', ':D' => 'big_smile.png', '=D' => 'big_smile.png', ':o' => 'yikes.png', ':O' => 'yikes.png', ';)' => 'wink.png', ':/' => 'hmm.png', ':P' => 'tongue.png', ':p' => 'tongue.png', ':lol:' => 'lol.png', ':mad:' => 'mad.png', ':rolleyes:' => 'roll.png', ':cool:' => 'cool.png');
	create_manifest($combos, FORUM_ROOT.'img/smilies/default/default.php');
	
	//Create options
	$new_config = array(
		'o_default_smilies'		=> 'default'
	);
	foreach($new_config as $key => $value)
	{
		if (!isset($forum_config[$key]))
		{
			$query = array(
				'INSERT'	=> 'conf_name, conf_value',
				'INTO'		=> 'config',
				'VALUES'	=> '\''.$key.'\', \''.$value.'\''
			);
			$forum_db->query_build($query) or error(__FILE__, __LINE__);
		}
	}
}
		]]>
	</install>
	
	<uninstall>
		<![CDATA[
require $ext_info['path'].'/functions.php';

if ($handle = opendir(FORUM_ROOT.'img/smilies'))
{
	while (false !== ($folder = readdir($handle)))
		if ($folder != "." && $folder != ".." && is_dir(FORUM_ROOT.'img/smilies/'.$folder) && substr($folder, 0, 1) != '.')
			recursive_unlink(FORUM_ROOT.'img/smilies/'.$folder);
	closedir($handle);
}
		]]>
	</uninstall>
	
	<hooks>
		<hook id="co_modify_url_scheme">
			<![CDATA[
$forum_url['admin_settings_smilies'] = 'admin/settings.php?section=smilies';
$forum_url['admin_settings_smilies_action'] = 'admin/settings.php?section=smilies&amp;action=$1&amp;set=$2&amp;csrf_token=$3';
$forum_url['admin_settings_smilies_action2'] = 'admin/settings.php?section=smilies&amp;action=$1&amp;set=$2';
			]]>
		</hook>
		<hook id="ca_fn_generate_admin_menu_new_sublink">
			<![CDATA[
if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php'))
	include $ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php';
else
	include $ext_info['path'].'/lang/English/'.$ext_info['id'].'.php';

if (FORUM_PAGE_SECTION == 'settings')
	$forum_page['admin_submenu']['backup'] = '<li class="'.((FORUM_PAGE == 'admin-settings-smilies') ? 'active' : 'normal').((empty($forum_page['admin_submenu'])) ? ' first-item' : '').'"><a href="'.forum_link($forum_url['admin_settings_smilies']).'">'.$lang_smilies['Smilies'].'</a></li>';
			]]>
		</hook>
		<hook id="ps_start">
			<![CDATA[
//Include our smiley combos
require FORUM_ROOT.'img/smilies/'.$forum_config['o_default_smilies'].'/'.$forum_config['o_default_smilies'].'.php';

//Replace the $smilies array with our new one
$smilies = array();
foreach($combos as $k=>$v) $smilies[$k] = $forum_config['o_default_smilies'].'/'.$v;
			]]>
		</hook>
		<hook id="ps_do_smilies_end">
			<![CDATA[
$text = str_replace('width="15" height="15"', '', $text);
			]]>
		</hook>
		<hook id="aop_new_section">
			<![CDATA[
if ($section == 'smilies')
{
	if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php'))
		include $ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php';
	else
		include $ext_info['path'].'/lang/English/'.$ext_info['id'].'.php';
	
	require $ext_info['path'].'/functions.php';
	
	if(isset($_GET['action']) && isset($_GET['set']))
	{
		$set = preg_replace('/[^0-9a-z_]/', '', $_GET['set']);
		
		if(!in_array($_GET['action'], array('default', 'edit', 'delete', 'download')))
			message($lang_smilies['Invalid action'].sprintf($lang_smilies['Back'], forum_link($forum_url['admin_settings_smilies'])));
		
		if (!isset($_POST['csrf_token']) && (!isset($_GET['csrf_token']) || $_GET['csrf_token'] !== generate_form_token($_GET['action'].'_'.$set)) && $_GET['action'] != 'edit')
			csrf_confirm_form();
		
		if($_GET['action'] == 'default')
		{
			//Lets see if we get errors
			$result = get_sets($set);
			
			//Got errors?
			if(!empty($result['errors']))
				message(implode("<br />", $result['errors']).sprintf($lang_smilies['Back'], forum_link($forum_url['admin_settings_smilies'])));
			
			//Update the config
			$query = array(
				'UPDATE'	=> 'config',
				'SET'		=> 'conf_value=\''.$set.'\'',
				'WHERE'		=> 'conf_name=\'o_default_smilies\''
			);
			$forum_db->query_build($query) or error(__FILE__, __LINE__);
			
			//Regenerate the config cache
			if (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))
				require FORUM_ROOT.'include/cache.php';

			generate_config_cache();
			
			redirect(forum_link($forum_url['admin_settings_smilies']), $lang_smilies['Successful default']);
		}
		elseif($_GET['action'] == 'edit')
		{
			//Lets see if we get errors
			$result = get_sets($set);
			
			//Got errors?
			if(!empty($result['errors']))
				message(implode("<br />", $result['errors']).sprintf($lang_smilies['Back'], forum_link($forum_url['admin_settings_smilies'])));
			
			if(isset($_POST['smilies']))
			{
				foreach($_POST['smilies'] as $k=>$v)
					if(empty($v) && in_array($k, $result['sets'][$set]))
					{
						unlink(FORUM_ROOT.'img/smilies/'.$set.'/'.$k);
						unset($_POST['smilies'][$k]);
					}
				
				$smilies = parse_form_combos($_POST['smilies']);
				
				foreach(array_keys($smilies) as $key)
				{
					$used[$key] = 0;
					foreach($_POST['smilies'] as $k=>$v)
					{
						if(strpos($v, $key) !== false)
							$used[$key]++;
						if($used[$key] > 1)
						{
							$errors[] = sprintf($lang_smilies['Edit duped'], forum_htmlencode($key));
							break;
						}
					}
				}
				
				if(isset($errors))
					message(implode("<br />", $errors).sprintf($lang_smilies['Back'], forum_link($forum_url['admin_settings_smilies_action2'], array('edit', $set))));
				
				create_manifest($smilies, FORUM_ROOT.'img/smilies/'.$set.'/'.$set.'.php');
				
				redirect(forum_link($forum_url['admin_settings_smilies_action2'], array('edit', $set)), $lang_smilies['Successful edit']);
			}
			
			if(isset($_POST['smiley']))
			{
				if(!isset($_FILES['image']))
					message($lang_smilies['Edit no image'].sprintf($lang_smilies['Back'], forum_link($forum_url['admin_settings_smilies_action2'], array('edit', $set))));
				else
					$uploaded_file = $_FILES['image'];
				
				if(empty($_POST['smiley']['combos']))
					message($lang_smilies['Edit no combos'].sprintf($lang_smilies['Back'], forum_link($forum_url['admin_settings_smilies_action2'], array('edit', $set))));
				
				$smilies = explode(', ', $_POST['smiley']['combos']);
				
				foreach(group_combos($result['sets'][$set]) as $k=>$v)
					foreach($smilies as $key)
						if(in_array($key, $v))
							$errors[] = sprintf($lang_smilies['Edit used'], forum_htmlencode($key));
				
				require FORUM_ROOT.'lang/'.$forum_user['language'].'/profile.php';
				
				if (isset($uploaded_file['error']) && empty($errors))
				{
					switch ($uploaded_file['error'])
					{
						case 1:	// UPLOAD_ERR_INI_SIZE
						case 2:	// UPLOAD_ERR_FORM_SIZE
							$errors[] = $lang_profile['Too large ini'];
							break;
						case 3:	// UPLOAD_ERR_PARTIAL
							$errors[] = $lang_profile['Partial upload'];
							break;
						case 4:	// UPLOAD_ERR_NO_FILE
							$errors[] = $lang_profile['No file'];
							break;
						case 6:	// UPLOAD_ERR_NO_TMP_DIR
							$errors[] = $lang_profile['No tmp directory'];
							break;
						default:
							// No error occured, but was something actually uploaded?
							if ($uploaded_file['size'] == 0)
								$errors[] = $lang_profile['No file'];
							break;
					}
				}
				
				if (is_uploaded_file($uploaded_file['tmp_name']) && empty($errors))
				{
					$allowed_types = array('image/gif', 'image/jpeg', 'image/pjpeg', 'image/png', 'image/x-png');
					
					if (!in_array($uploaded_file['type'], $allowed_types))
						$errors[] = $lang_profile['Bad type'];
					else
					{
						// Make sure the file isn't too big
						if ($uploaded_file['size'] > $forum_config['o_avatars_size'])
							$errors[] = sprintf($lang_profile['Too large'], forum_number_format($forum_config['o_avatars_size']));
					}
					
					foreach($result['sets'][$set] as $k=>$v)
						if($uploaded_file['name'] == $v)
						{
							$errors[] = sprintf($lang_smilies['Edit exists'], $uploaded_file['name']);
							break;
						}
					
					if (empty($errors))
					{
						// Move the file to the avatar directory.
						if (!@move_uploaded_file($uploaded_file['tmp_name'], FORUM_ROOT.'img/smilies/'.$set.'/'.$uploaded_file['name']))
							$errors[] = sprintf($lang_profile['Move failed'], '<a href="mailto:'.forum_htmlencode($forum_config['o_admin_email']).'">'.forum_htmlencode($forum_config['o_admin_email']).'</a>');
					}
				}
				else if (empty($errors))
					$errors[] = $lang_profile['Unknown failure'];
				
				if(isset($errors))
					message(implode("<br />", $errors).sprintf($lang_smilies['Back'], forum_link($forum_url['admin_settings_smilies_action2'], array('edit', $set))));
				
				foreach($smilies as $key)
					$result['sets'][$set][$key] = $uploaded_file['name'];
				
				create_manifest($result['sets'][$set], FORUM_ROOT.'img/smilies/'.$set.'/'.$set.'.php');
				
				redirect(forum_link($forum_url['admin_settings_smilies_action2'], array('edit', $set)), $lang_smilies['Successful add']);
			}
			
			$forum_page['crumbs'] = array(
				array($forum_config['o_board_title'], forum_link($forum_url['index'])),
				array($lang_admin_common['Forum administration'], forum_link($forum_url['admin_index'])),
				array($lang_admin_common['Settings'], forum_link($forum_url['admin_settings_setup'])),
				array($lang_smilies['Smilies'], forum_link($forum_url['admin_settings_smilies'])),
				array($lang_smilies['Edit'], forum_link($forum_url['admin_settings_smilies_action2'], array('edit', $set)))
			);
			
			define('FORUM_PAGE_SECTION', 'settings');
			define('FORUM_PAGE', 'admin-settings-smilies');
			require FORUM_ROOT.'header.php';
			
			$forum_page['group_count'] = $forum_page['item_count'] = $forum_page['field_count'] = 0;
			
			//In a function to keep this clean
			$tpl_main = str_replace('<!-- forum_main -->', edit_page(), $tpl_main);
			
			require FORUM_ROOT.'footer.php';
		}
		elseif($_GET['action'] == 'delete')
		{
			//Does this set even exist or is a directory?
			if(!file_exists(FORUM_ROOT.'img/smilies/'.$set) || !is_dir(FORUM_ROOT.'img/smilies/'.$set))
				message($lang_smilies['Invalid set'].sprintf($lang_smilies['Back'], forum_link($forum_url['admin_settings_smilies'])));
			
			//Is this the default set? If so, let the admin choose another default set before deleting this one
			if($set == $forum_config['o_default_smilies'])
				message($lang_smilies['Change default'].sprintf($lang_smilies['Back'], forum_link($forum_url['admin_settings_smilies'])));
			
			//Everything seems ok...
			recursive_unlink(FORUM_ROOT.'img/smilies/'.$set);
			
			redirect(forum_link($forum_url['admin_settings_smilies']), $lang_smilies['Successful delete']);
		}
		elseif($_GET['action'] == 'download')
		{
			if(!class_exists('ZipArchive'))
				message($lang_smilies['No zip 2'].sprintf($lang_smilies['Back'], forum_link($forum_url['admin_settings_smilies'])));
			
			//Lets see if we get errors
			$result = get_sets($set);
			
			//Got errors?
			if(!empty($result['errors']))
				message(implode("<br />", $result['errors']).sprintf($lang_smilies['Back'], forum_link($forum_url['admin_settings_smilies'])));
			
			//Lets make the Zip
			$zip = new ZipArchive;
			$res = $zip->open(FORUM_ROOT.'img/smilies/'.$set.'/zip.zip', ZipArchive::CREATE);
			if($res === TRUE)
			{
				include(FORUM_ROOT.'img/smilies/'.$set.'/'.$set.'.php');
				
				foreach($combos as $k=>$v)
					$zip->addFile(FORUM_ROOT.'img/smilies/'.$set.'/'.$v, $set.'/'.$v);
				
				$zip->addFile(FORUM_ROOT.'img/smilies/'.$set.'/'.$set.'.php', $set.'/'.$set.'.php');
				
				$zip->close();
			}
			
			//Output the zip
			header("Content-Type: application/zip");
			header('Content-Disposition: attachment;filename="'.$set.'.zip"');
			echo file_get_contents(FORUM_ROOT.'img/smilies/'.$set.'/zip.zip');
			
			//Delete the zip
			unlink(FORUM_ROOT.'img/smilies/'.$set.'/zip.zip');
			
			//Bye
			exit;
		}
	}
	
	// Setup breadcrumbs
	$forum_page['crumbs'] = array(
		array($forum_config['o_board_title'], forum_link($forum_url['index'])),
		array($lang_admin_common['Forum administration'], forum_link($forum_url['admin_index'])),
		array($lang_admin_common['Settings'], forum_link($forum_url['admin_settings_setup'])),
		array($lang_smilies['Smilies'], forum_link($forum_url['admin_settings_smilies']))
	);

	define('FORUM_PAGE_SECTION', 'settings');
	define('FORUM_PAGE', 'admin-settings-smilies');
	require FORUM_ROOT.'header.php';
	
	$forum_page['group_count'] = $forum_page['item_count'] = $forum_page['field_count'] = 0;

	// START SUBST - <!-- forum_main -->
	ob_start();

?>
	<div class="main-content main-frm">
<?php
	if(!class_exists('ZipArchive'))
	{
?>
		<div class="ct-box">
			<p class="warn"><?php echo $lang_smilies['No zip'] ?></p>
		</div>
<?php
	}//ziparchive
?>
		<div class="content-head">
			<h2 class="hn"><span><?php echo $lang_smilies['Title'] ?></span></h2>
		</div>
		<div class="main-extensions">
<?php
	$result = get_sets();
	
	//Lets display our valid sets
	foreach($result['sets'] as $name=>$smilies)
	{
		$opts = array();
		
		if($name != $forum_config['o_default_smilies'])
			$opts[] = '<span class="first-item"><a href="'.forum_link($forum_url['admin_settings_smilies_action'], array('default', $name, generate_form_token('default_'.$name))).'">'.$lang_smilies['Default'].'</a></span>';
		else
			$opts[] = '<span class="first-item">'.$lang_smilies['Default'].'</span>';
		
		$opts[] = '<span><a href="'.forum_link($forum_url['admin_settings_smilies_action2'], array('edit', $name)).'">'.$lang_smilies['Edit'].'</a></span>';
		$opts[] = '<span><a href="'.forum_link($forum_url['admin_settings_smilies_action'], array('delete', $name, generate_form_token('delete_'.$name))).'">'.$lang_smilies['Delete'].'</a></span>';
		
		if(class_exists('ZipArchive'))
			$opts[] = '<span><a href="'.forum_link($forum_url['admin_settings_smilies_action'], array('download', $name, generate_form_token('download_'.$name))).'">'.$lang_smilies['Download'].'</a></span>';
?>
			<div class="ct-box info-box extension available">
				<h3 class="ct-legend hn"><span><?php echo $name ?></span><?php if($name == $forum_config['o_default_smilies']) echo ' <span style="font-weight:normal">'.$lang_smilies['Forum default'].'</span>' ?></h3>
				<p><?php foreach(group_combos($smilies) as $k=>$v) echo '<span title="'.implode(", ", $v).'"><img src="'.$base_url.'/img/smilies/'.$name.'/'.$k.'" alt="'.$k.'" /></span> '; ?></p>
				<p class="options">
					<?php echo implode("\n\t\t\t\t\t", $opts)."\n" ?>
				</p>
			</div>
<?php
	}//Foreach
	
	if(!empty($result['errors']))
	{
?>
			<div class="ct-box data-box">
				<p class="important"><?php echo $lang_smilies['Errors'] ?></p>
				<p><?php echo implode("</p>\n\t\t\t\t<p>", $result['errors'])."</p>\n" ?>
			</div>
<?php
	}
?>
		</div>
		<div class="content-head">
			<h2 class="hn"><span><?php echo $lang_smilies['Upload'] ?></span></h2>
		</div>
		<div class="ct-box">
			<p class="warn">This will be added on the next version.</p>
		</div>
	</div>
<?php
}//section
			]]>
		</hook>
	</hooks>
</extension>